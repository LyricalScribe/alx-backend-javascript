/**
 * Copyright (c) 2017-present, Facebook, Inc. All rights reserved.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 *
 */

'use strict';

Object.defineProperty(exports, '__esModule', {
  value: true
});
<<<<<<< HEAD

var _prettyFormat;

function _load_prettyFormat() {
  return (_prettyFormat = _interopRequireDefault(require('pretty-format')));
}

var _v;

function _load_v() {
  return (_v = _interopRequireDefault(require('v8')));
}

var _vm;

function _load_vm() {
  return (_vm = _interopRequireDefault(require('vm')));
=======
exports.default = void 0;
function _util() {
  const data = require('util');
  _util = function () {
    return data;
  };
  return data;
}
function _v() {
  const data = require('v8');
  _v = function () {
    return data;
  };
  return data;
}
function _vm() {
  const data = require('vm');
  _vm = function () {
    return data;
  };
  return data;
}
function _jestGetType() {
  const data = require('jest-get-type');
  _jestGetType = function () {
    return data;
  };
  return data;
>>>>>>> 74277b58428b76b5d4577f14d767a83dccdacaf2
}
function _prettyFormat() {
  const data = require('pretty-format');
  _prettyFormat = function () {
    return data;
  };
  return data;
}
/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/// <reference lib="es2021.WeakRef" />

<<<<<<< HEAD
exports.default = class {
  constructor(value) {
    if (this._isPrimitive(value)) {
      throw new TypeError(
        [
          'Primitives cannot leak memory.',
          'You passed a ' +
            typeof value +
            ': <' +
            (0, (_prettyFormat || _load_prettyFormat()).default)(value) +
            '>'
=======
const tick = (0, _util().promisify)(setImmediate);
class LeakDetector {
  _isReferenceBeingHeld;
  _finalizationRegistry;
  constructor(value) {
    if ((0, _jestGetType().isPrimitive)(value)) {
      throw new TypeError(
        [
          'Primitives cannot leak memory.',
          `You passed a ${typeof value}: <${(0, _prettyFormat().format)(
            value
          )}>`
>>>>>>> 74277b58428b76b5d4577f14d767a83dccdacaf2
        ].join(' ')
      );
    }

<<<<<<< HEAD
    let weak;

    try {
      // eslint-disable-next-line import/no-extraneous-dependencies
      weak = require('weak');
    } catch (err) {
      if (!err || err.code !== 'MODULE_NOT_FOUND') {
        throw err;
      }

      throw new Error(
        'The leaking detection mechanism requires the "weak" package to be installed and work. ' +
          'Please install it as a dependency on your main project'
      );
    }

    weak(value, () => (this._isReferenceBeingHeld = false));
=======
    // When `_finalizationRegistry` is GCed the callback we set will no longer be called,
    this._finalizationRegistry = new FinalizationRegistry(() => {
      this._isReferenceBeingHeld = false;
    });
    this._finalizationRegistry.register(value, undefined);
>>>>>>> 74277b58428b76b5d4577f14d767a83dccdacaf2
    this._isReferenceBeingHeld = true;

    // Ensure value is not leaked by the closure created by the "weak" callback.
    value = null;
  }
  async isLeaking() {
    this._runGarbageCollector();

    // wait some ticks to allow GC to run properly, see https://github.com/nodejs/node/issues/34636#issuecomment-669366235
    for (let i = 0; i < 10; i++) {
      await tick();
    }
    return this._isReferenceBeingHeld;
  }
  _runGarbageCollector() {
<<<<<<< HEAD
    const isGarbageCollectorHidden = !global.gc;

    // GC is usually hidden, so we have to expose it before running.
    (_v || _load_v()).default.setFlagsFromString('--expose-gc');
    (_vm || _load_vm()).default.runInNewContext('gc')();

    // The GC was not initially exposed, so let's hide it again.
    if (isGarbageCollectorHidden) {
      (_v || _load_v()).default.setFlagsFromString('--no-expose-gc');
    }
  }

  _isPrimitive(value) {
    return value !== Object(value);
  }
};
=======
    // @ts-expect-error: not a function on `globalThis`
    const isGarbageCollectorHidden = globalThis.gc == null;

    // GC is usually hidden, so we have to expose it before running.
    (0, _v().setFlagsFromString)('--expose-gc');
    (0, _vm().runInNewContext)('gc')();

    // The GC was not initially exposed, so let's hide it again.
    if (isGarbageCollectorHidden) {
      (0, _v().setFlagsFromString)('--no-expose-gc');
    }
  }
}
exports.default = LeakDetector;
>>>>>>> 74277b58428b76b5d4577f14d767a83dccdacaf2
